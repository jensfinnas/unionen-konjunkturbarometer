!function(){"use strict";function a(a,b,c){for(var d="undefined"!=typeof c?[c]:document.styleSheets,e=0,f=d.length;f>e;e++){var c=d[e];if(c.cssRules)for(var g=0,h=c.cssRules.length;h>g;g++){var i=c.cssRules[g];if(i.selectorText&&-1!==i.selectorText.split(",").indexOf(b))return i.style[a]}}return null}function b(a){return a.replace(/[\s:]/g,"-").replace(/[åä]/gi,"a").replace(/[ö]/gi,"o").toLowerCase()}function c(a){var b=$(a),c=b.attr("data-category"),d=b.attr("data-group"),e=b.attr("data-subgroup"),f=n.first(function(a){return a.id==d});e&&(f=f.subgroups.first(function(a){return a.id==e}));var g=new u({container:d3.select(a),data:f.values,category:c,group:d,subgroup:e});b.data("chart",g)}function d(){q.render("cards",function(a){q.render("history",function(b){Handlebars.registerPartial("history",b),k.html(a({groups:n})).isotope({itemSelector:".card",layoutMode:"fitRows",filter:".foo"}).find(".history-chart").each(function(){c(this)}),ri.messageParent(),f(i())})})}function e(a){var b=a.find(".card-section.trend .history-chart"),c=b.data("chart");b.data("chart",c.redraw())}function f(a){var b=k.find(".card.selected");k.find(".card").removeClass("selected").removeClass("active-category"),a.category=a.category||"industry",$(".card[data-category="+a.category+"]").addClass("active-category"),l.find("li").removeClass("active"),l.find("li[data-category="+a.category+"]").addClass("active");var d=".card.active-category";if(a.group){var f=n.first(function(b){return a.group==b.id});q.render("subgroups",function(b){var g=k.find(".card[data-group="+a.group+"]").addClass("selected");e(g),g.find(".subgroups").html(b({category:a.category,group:a.group,groups:f.subgroups})).find(".history-chart").each(function(){c(this)}),d+=".selected",k.isotope({filter:d})})}else b.length>0&&e(b),k.isotope({filter:d})}function g(a){return a=a.map(function(a){a.id=b(a.name);var c=a.subgroups.map(function(a){return a.values.map(function(a){return a})});a.values=d3.transpose(c).map(function(a){return{date:a[0].date,value:d3.mean(a.map(function(a){return a.value}))}});var d=a.subgroups.map(function(a){return a.values[0].value});return a.outlook=v(d3.mean(d)),a.subgroups.map(function(a){return a.id=b(a.name),a.outlook=v(a.values[0].value),a}),a})}function h(a,c){var e=a.Nyckeltal.elements[0];delete a.Nyckeltal,j=d3.map({}),a.Ordbok.elements.forEach(function(a){j.set(b(a.word),a)}),delete a.Ordbok,n.industry=d3.entries(a).map(function(a){return a.name=a.key,a.category="industry",a.subgroups=a.value.column_names.map(function(b){var c=a.value.elements.map(function(a){var c="undefined"!=typeof a[b]?+a[b].replace(",","."):null;return{date:t(a.datum),value:c}}).filter(function(a){return!isNaN(a.value)});return{name:e[b],values:c}}).filter(function(a){return"undefined"!=typeof a.name}),delete a.key,delete a.value,a}),n.category=c.sheets(c.model_names[0]).column_names.map(function(b){var c=d3.entries(a).map(function(c){var d=a[c.key].elements.map(function(a){var c="undefined"!=typeof a[b]?+a[b].replace(",","."):null;return{date:t(a.datum),value:c}}).filter(function(a){return!isNaN(a.value)});return{name:c.key,values:d}});return{name:e[b],category:"category",subgroups:c}}).filter(function(a){return"undefined"!=typeof a.name}),n.category=g(n.category),n.industry=g(n.industry),n=n.industry.concat(n.category),d3.selectAll(".loading").style("display","none"),d()}function i(){var a={category:null,group:null,subgroup:null},b=window.location.hash;return""!==b&&(b=b.replace("#","").split("_"),b.length>=1&&(a.category=b[0]),b.length>=2&&(a.group=b[1]),b.length>=3&&(a.subgroup=b[2])),a}var j,k,l,m="1JGCoMlEqUaspT-S_7UK-lVK8JfzHItdHyUQO_LYdFus",n={};Handlebars.registerHelper("dictionary",function(a,c,d){return a=j.get(b(a))[c],d&&(a=a.toLowerCase()),a}),Handlebars.registerHelper("toLowerCase",function(a){return a.toLowerCase()});var o=[{v0:10.45,v1:12.5,label:"Väldigt optimistisk",labelDetermined:"Väldigt optimistiskt",className:"p3"},{v0:5.45,v1:10.45,label:"Optimistisk",labelDetermined:"Optimistiskt",className:"p2"},{v0:.45,v1:5.45,label:"Försiktigt optimistisk",labelDetermined:"Försiktigt optimistiskt",className:"p1"},{v0:-.45,v1:.45,label:"Neutral",labelDetermined:"Neutralt",className:"neutral"},{v0:-5.45,v1:-.45,label:"Försiktigt pessimistisk",labelDetermined:"Försiktigt pessimistiskt",className:"n1"},{v0:-10.45,v1:-5.45,label:"Pessimistisk",labelDetermined:"Pessimistiskt",className:"n2"},{v0:-12.5,v1:-10.45,label:"Väldigt pessimistisk",labelDetermined:"Väldigt pessimistiskt",className:"n3"}].map(function(b){return b.color=a("background-color","."+b.className),b});Array.prototype.first||(Array.prototype.first=function(a){if(null==this)throw new TypeError;if("function"!=typeof a)throw new TypeError;for(var b=0;b<this.length;b++)if(a(this[b]))return this[b];return null});var p=(function(){for(var a={},b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if("undefined"==typeof a[e[0]])a[e[0]]=e[1];else if("string"==typeof a[e[0]]){var f=[a[e[0]],e[1]];a[e[0]]=f}else a[e[0]].push(e[1])}return a}(),function(){this.cached={}}),q=new p;$.extend(p.prototype,{render:function(a,b){q.isCached(a)?b(q.cached[a]):$.get(q.urlFor(a),function(c){q.store(a,c),q.render(a,b)})},renderSync:function(a,b){q.isCached(a)||q.fetch(a),q.render(a,b)},prefetch:function(a){$.get(q.urlFor(a),function(b){q.store(a,b)})},fetch:function(a){if(!q.isCached(a)){var b=$.ajax({url:q.urlFor(a),async:!1}).responseText;q.store(a,b)}},isCached:function(a){return!!q.cached[a]},store:function(a,b){q.cached[a]=Handlebars.compile(b)},urlFor:function(a){return"templates/"+a+".hbs"}});var r=d3.locale({decimal:",",thousands:" ",grouping:[3],currency:[""," kr"],dateTime:"%A %e %B %Y kl. %X",date:"%d.%m.%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["måndag","tisdag","onsdag","torsdag","fredag","lördag","söndag"],shortDays:["må","ti","ons","to","fre","lö","sö"],months:["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"],shortMonths:["jan","feb","mars","apr","maj","jun","jul","aug","sept","okt","nov","dec"]}),s=r.timeFormat("%B %Y"),t=r.timeFormat("%Y-%m-%d").parse,u=function(){function a(a){var b,c,d,e,f,g,h,i,k,l,m=this;m.opts=a,m.container=f=a.container,m.data=g=a.data,m.category=i=a.category,m.group=k=a.group,m.subgroup=l=a.subgroup,m.el=f.select(".chart"),m.mini=h=!$(f[0][0]).parents(".card").hasClass("selected");var n=h?45:400;m.margin={top:h?0:3,bottom:h?0:30,right:h?0:15,left:5};var p=m.margin;m.width=b=n-p.left-p.right,m.height=c=h?.6*b:.4*b,f.select(".chart-intro .group-name").text(j.get(k).determined.toLowerCase()),m.date1=e=g[0].date,m.date0=d=g[g.length-1].date,m.min=h?-6:-9,m.max=h?6:9,m.x=d3.time.scale().range([0,b]).domain([d,e]),m.y=d3.scale.linear().range([c,0]).domain([m.min,m.max]),m.el.select("svg").remove(),m.svg=m.el.append("svg").attr("width",b+p.left+p.right).attr("height",c+p.top+p.bottom),m.chart=m.svg.append("g").attr("transform","translate("+p.left+","+p.top+")").on("mouseout",function(){m.tooltip.style("visibility","hidden")});var q=d3.geom.voronoi().clipExtent([[0,0],[b,c]]),r=g.map(function(a){var b=[m.x(a.date),m.y(a.value)],c=v(a.value);return[b[0],b[1],{date:a.date,value:a.value,outlook:c}]}),t=q(r);m.tooltip=d3.select("body").append("div").attr("class","d3-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").on("mouseover",function(){return m.tooltip.style("visibility","hidden")}),m.bgAreas=m.chart.selectAll("g.bg-area").data(o).enter().append("g").attr("class",function(a){return"bg-area line-"+a.className}).attr("transform",function(a){return"translate(0,"+m.y(a.v1)+")"}),m.bgAreas.append("rect").attr("x",-m.margin.left).attr("width",m.margin.left).attr("height",function(a){return Math.abs(m.y(a.v1)-m.y(a.v0))}).attr("fill",function(a){return a.color}),m.bgAreas.append("line").attr("x1",0).attr("x2",b).attr("y1",function(a){return a.v1>0?0:m.y(a.v0)-m.y(a.v1)}).attr("y2",function(a){return a.v1>0?0:m.y(a.v0)-m.y(a.v1)}).attr("stroke",function(a){return a.color}).attr("class","guideline"),m.chart.selectAll(".bg-area.line-neutral").append("line").attr("x1",0).attr("x2",b).attr("y1",function(a){return m.y(a.v0)-m.y(a.v1)}).attr("y2",function(a){return m.y(a.v0)-m.y(a.v1)}).attr("stroke",function(a){return a.color}).attr("class","guideline"),m.chart.append("line").attr("x1",0).attr("x2",b).attr("y1",m.y(0)).attr("y2",m.y(0)).attr("class","guideline zero").attr("transform","translate(1,0)"),m.chart.append("rect").attr("width",b+m.margin.left+m.margin.right).attr("height",m.margin.bottom).attr("y",c).attr("x",-m.margin.left).attr("fill","#fff"),m.xAxis=d3.svg.axis().scale(m.x).orient("bottom").ticks(3),m.chart.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(m.xAxis),m.chart.append("text").attr("class","y-label").text("Optimistisk").attr("x",5).attr("y",0).attr("dy",".7em"),m.chart.append("text").attr("class","y-label").text("Pessimistisk").attr("x",5).attr("y",c).attr("dy",0),m.line=d3.svg.line().x(function(a){return m.x(a.point[2].date)}).y(function(a){return m.y(a.point[2].value)}),m.chart.append("path").datum(t).attr("class","line").attr("d",m.line),m.dots=m.chart.selectAll("g.poll").data(t).enter().append("g").attr("class","poll"),m.dotSize=4,m.dots.append("circle").attr("r",m.dotSize).attr("cx",m.dotSize/2).attr("class","dot").attr("transform",function(a){return"translate("+[a.point[0],a.point[1]]+")"}),m.dots.append("path").attr("class","voronoi").attr("opacity",1e-6).attr("d",function(a){return"M"+a.join("L")+"Z"}).on("mouseover",function(){var a=this.parentNode.childNodes[0],b=document.body.getBoundingClientRect(),c=a.getBoundingClientRect(),d={top:c.top-b.top,left:c.left-b.left},e=d3.select(a),f=e[0][0].__data__,g=f.point[2].outlook;return e.transition().duration(200).attr("r",2*m.dotSize),m.tooltip.html('<table><tr><td><span class="icon-arrow outlook '+g.className+'"></span></td><td><date>'+s(f.point[2].date)+"</date> "+g.label+"</td></tr></table>").style("visibility","visible").style("top",d.top-65+"px").style("left",function(){var a=this.getBoundingClientRect().width;return d.left-a/2+"px"})}).on("mouseout",function(){var a=d3.select(this.parentNode.childNodes[0]);a.transition().duration(200).attr("r",m.dotSize)}),m.getSentences=function(a,b,c,d){function e(a){return"<strong>"+a.label.toLowerCase()+"</strong>"}var f,g=a[0].value,h=a[1].value,i=v(g),k=i.labelDetermined.toLowerCase(),l=g>h?"postiv":"negativ",m=g>h&&g>0||h>g&&0>g?"även":"dock",n=Math.abs(g-h);1>n?f="Något":2>n?f="":3>n&&(f="Betydligt");var o={};if(d){if("industry"==b)var p=j.get(c).determined.toLowerCase(),q=j.get(d).determined.toLowerCase();else if("category"==b)var p=j.get(d).determined.toLowerCase(),q=j.get(c).determined.toLowerCase();o.long="Inom "+p+" ser man <strong>"+k+"</strong> på utvecklingen för "+q+" det kommande halvåret."}else{var r=j.get(c).determined.toLowerCase();"industry"==b?o.long="Inom "+r+" ser man just nu "+e(i)+"  på framtiden. ":"category"==b&&(o.long="Unionens medlemmar ser just nu "+e(i)+" på framtiden för "+r+". ")}return o.long+="Man är "+m+" <strong>"+f+" mer "+l+"</strong> än för sex månader sedan.",o.title="Trenden: "+f+" mer "+l+" än senast",o.trend=f+" mer "+l,o};var u=m.getSentences(g,i,k,l);m.container.select(".trend .value").html(u.trend)}return a.prototype.redraw=function(){var b=this;return new a(b.opts)},a}(),v=function(a){var b=o.first(function(b){return b.v0<a&&a<=b.v1});return b},w=function(a){if($(".card").toggleClass("hidden-card"),a.hasClass("selected"))a.on("click");else{a.off("click");var b=n.industry.first(function(b){return a.attr("data-group")==b.name});q.render("history",function(c){a.find(".history").html(c(b))}),q.render("subgroups",function(c){a.find(".subgroups").html(c({group:a.attr("data-group"),groups:b.subgroups}))})}a.removeClass("hidden-card").toggleClass("selected"),k.isotope({filter:":not(.hidden-card)"})};$(window).on("hashchange",function(){var a=i();f(a)}),$(document).ready(function(){q.render("main",function(a){$("#konjunkturbarometern").html(a()),k=$("#cards"),l=$(".nav"),$(".btn-back").click(function(){w($(".card.selected"))}),Tabletop.init({key:m,callback:h,proxy:"https://s3-eu-west-1.amazonaws.com/tabletop-proxy/unionen-konjunkturbarometern-stage/",debug:!0})})})}();