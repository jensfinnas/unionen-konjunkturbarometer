var d,_tt;!function(){"use strict";function a(a){return a.replace(/[\s:]/g,"-").replace(/[åä]/gi,"a").replace(/[ö]/gi,"o").toLowerCase()}function b(a){console.log(a);var b=$("#konjunkturbarometern-template").html(),c=Handlebars.compile(b),d=c(a);$(".container").html(d),d3.selectAll(".history-chart").each(function(){var b=d3.select(this),c=b.attr("data-group"),d=b.attr("data-subgroup"),e=a.first(function(a){return a.name==c}).subgroups.first(function(a){return a.name==d}).values;new l(b,e)})}function c(b){return b=b.map(function(b){var c=b.subgroups.map(function(a){return a.values[0].value});b.id=a(b.name);var d=k(d3.mean(c));return b.outlook=d,b.subgroups.map(function(b){b.id=a(b.name);var c=k(b.values[0].value);return b.outlook=c,b}),b})}function d(a,d){_tt=d;var e=a.Nyckeltal.elements[0];delete a.Nyckeltal,f.industry=d3.entries(a).map(function(a){return a.name=a.key,a.subgroups=a.value.column_names.map(function(b){var c=a.value.elements.map(function(a){var c="undefined"!=typeof a[b]?+a[b].replace(",","."):null;return{date:j(a.datum),value:c}}).filter(function(a){return!isNaN(a.value)});return{name:e[b],values:c}}).filter(function(a){return"undefined"!=typeof a.name}),delete a.key,delete a.value,a}),f.category=d.sheets(d.model_names[0]).column_names.map(function(b){var c=d3.entries(a).map(function(c){var d=a[c.key].elements.map(function(a){var c="undefined"!=typeof a[b]?+a[b].replace(",","."):null;return{date:j(a.datum),value:c}}).filter(function(a){return!isNaN(a.value)});return{name:c.key,values:d}});return{name:e[b],subgroups:c}}).filter(function(a){return"undefined"!=typeof a.name}),f.category=c(f.category),f.industry=c(f.industry),b(f.category)}var e="1JGCoMlEqUaspT-S_7UK-lVK8JfzHItdHyUQO_LYdFus",f={},g=d3.scale.linear().domain([12.5,0,-12.5]).range(["green","white","red"]),h=[{v0:7.5,v1:12.5,label:"Väldigt optimistisk",rotate:20},{v0:2.5,v1:7.5,label:"Optimistisk",rotate:40},{v0:0,v1:2.5,label:"Försiktigt optimistisk",rotate:60},{v0:-2.5,v1:0,label:"Försiktigt pessimistisk",rotate:120},{v0:-7.5,v1:-2.5,label:"Pessimistisk",rotate:140},{v0:-12.5,v1:-7.5,label:"Väldigt pessimistisk",rotate:160}].map(function(a){return console.log((a.v1+a.v0)/2),a.color=g((a.v1+a.v0)/2),a});console.log(h),Array.prototype.first||(Array.prototype.first=function(a){if(null==this)throw new TypeError;if("function"!=typeof a)throw new TypeError;for(var b=0;b<this.length;b++)if(a(this[b]))return this[b];return null});var i=d3.locale({decimal:",",thousands:" ",grouping:[3],currency:[""," kr"],dateTime:"%A %e %B %Y kl. %X",date:"%d.%m.%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["måndag","tisdag","onsdag","torsdag","fredag","lördag","söndag"],shortDays:["må","ti","ons","to","fre","lö","sö"],months:["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"],shortMonths:["jan","feb","mars","apr","maj","jun","jul","aug","sept","okt","nov","dec"]}),j=i.timeFormat("%Y-%m-%d").parse,k=function(a){var b=h.first(function(b){return b.v0<a&&a<=b.v1});return b},l=function(){function a(a,b){var c,d,e,f,g=this;g.el=a;var i=g.el[0][0].offsetWidth;i=400,g.margin={top:10,bottom:30,right:20,left:30};var j=g.margin;g.width=c=i-j.left-j.right,g.height=d=.35*c,g.date1=f=b[0].date,g.date0=e=b[b.length-1].date,g.min=-12.5,g.max=12.5,g.x=d3.time.scale().range([0,c]).domain([e,f]),g.y=d3.scale.linear().range([d,0]).domain([g.min,g.max]),g.svg=g.el.append("svg").attr("width",c+j.left+j.right).attr("height",d+j.top+j.bottom),g.chart=g.svg.append("g").attr("transform","translate("+j.left+","+j.top+")");var l=d3.geom.voronoi().clipExtent([[0,0],[c,d]]),m=b.map(function(a){var b=[g.x(a.date),g.y(a.value)],c=k(a.value);return[b[0],b[1],{date:a.date,value:a.value,outlook:c}]}),n=l(m);g.bgAreas=g.chart.selectAll("g.bg-area").data(h).enter().append("g").attr("class","bg-area").attr("transform",function(a){return"translate(0,"+g.y(a.v1)+")"}),g.bgAreas.append("rect").attr("width",c).attr("height",function(a){return Math.abs(g.y(a.v1)-g.y(a.v0))}).attr("fill",function(a){return a.color}).attr("stroke","white"),g.xAxis=d3.svg.axis().scale(g.x).orient("bottom").ticks(3),g.chart.append("g").attr("class","x axis").attr("transform","translate(0,"+d+")").call(g.xAxis),g.line=d3.svg.line().x(function(a){return g.x(a.point[2].date)}).y(function(a){return g.y(a.point[2].value)}),g.chart.append("path").datum(n).attr("class","line").attr("d",g.line),g.dots=g.chart.selectAll("g.poll").data(n).enter().append("g").attr("class","poll"),g.dotSize=4,g.dots.append("circle").attr("r",g.dotSize).attr("cx",g.dotSize/2).attr("class","dot").attr("transform",function(a){return"translate("+[a.point[0],a.point[1]]+")"}),g.dots.append("path").attr("class","voronoi").attr("opacity",1e-6).attr("d",function(a){return"M"+a.join("L")+"Z"}).on("mouseover",function(){{var a=this.parentNode.childNodes[0],b=d3.select(a);b[0][0].__data__}b.transition().duration(200).attr("r",3*g.dotSize)}).on("mouseout",function(){{var a=this.parentNode.childNodes[0],b=d3.select(a);b[0][0].__data__}b.transition().duration(200).attr("r",g.dotSize)}),g.getSentence=function(a){var b,c=a[0].value,d=a[1].value,e=c>d?"postivt":"negativt",f=Math.abs(c-d);return.5>f?b="något":1>f?b="":2>f&&(b="betydligt"),"Inom [industri] ser man "+b+" mer "+e+" på utvecklingen för [category] det kommande halvåret än för sex månader sedan."},g.el.append("div").attr("class","sentence").html(g.getSentence(b))}return a}();$(document).ready(function(){Tabletop.init({key:e,callback:d,proxy:"https://s3-eu-west-1.amazonaws.com/tabletop-proxy/unionen-konjunkturbarometern-stage/",debug:!0})})}();