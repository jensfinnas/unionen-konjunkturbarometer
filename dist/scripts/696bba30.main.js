var chart=function(){"use strict";function a(a,b,c){for(var d="undefined"!=typeof c?[c]:document.styleSheets,e=0,f=d.length;f>e;e++){var c=d[e];if(c.cssRules)for(var g=0,h=c.cssRules.length;h>g;g++){var i=c.cssRules[g];if(i.selectorText&&-1!==i.selectorText.split(",").indexOf(b))return i.style[a]}}return null}function b(a){return a.replace(/[\s:]/g,"-").replace(/[åä]/gi,"a").replace(/[ö]/gi,"o").toLowerCase()}function c(a,b){var c=j,d=c.show;d&&d.split(",").forEach(function(a){a=a.split("_");var c,d=b.first(function(b){return a[0]==b.id});2==a.length&&d&&(c=d.subgroups.first(function(b){return a[1]==b.id})),d&&(d.show="in"),c&&(c.show="in")});var e="#"+a;o.render("widget",function(d){$(e).html(d({groups:b,category:a})),c.cat&&(d3.selectAll(".nav.nav-tabs li").classed("active",function(){return d3.select(this).attr("data-category")==c.cat}),d3.selectAll(".tab-pane").classed("active",function(){return d3.select(this).attr("id")==c.cat})),d3.select(e).selectAll(".history-chart").each(function(){var c=d3.select(this),d=c.attr("data-group"),e=c.attr("data-subgroup");if(e)var f=b.first(function(a){return a.name==d}).subgroups.first(function(a){return a.name==e}).values;else var f=b.first(function(a){return a.name==d}).values;new q(c,f,a,d,e),d3.selectAll(".loading").style("display","none")})})}function d(a){return a=a.map(function(a){a.id=b(a.name);var c=a.subgroups.map(function(a){return a.values.map(function(a){return a})});a.values=d3.transpose(c).map(function(a){return{date:a[0].date,value:d3.mean(a.map(function(a){return a.value}))}});var d=a.subgroups.map(function(a){return a.values[0].value});return a.outlook=p(d3.mean(d)),a.subgroups.map(function(a){return a.id=b(a.name),a.outlook=p(a.values[0].value),a}),a})}function e(a,b){var e=a.Nyckeltal.elements[0];delete a.Nyckeltal,f=d3.map({}),a.Ordbok.elements.forEach(function(a){f.set(a.word,a)}),delete a.Ordbok,h.industry=d3.entries(a).map(function(a){return a.name=a.key,a.subgroups=a.value.column_names.map(function(b){var c=a.value.elements.map(function(a){var c="undefined"!=typeof a[b]?+a[b].replace(",","."):null;return{date:m(a.datum),value:c}}).filter(function(a){return!isNaN(a.value)});return{name:e[b],values:c}}).filter(function(a){return"undefined"!=typeof a.name}),delete a.key,delete a.value,a}),h.category=b.sheets(b.model_names[0]).column_names.map(function(b){var c=d3.entries(a).map(function(c){var d=a[c.key].elements.map(function(a){var c="undefined"!=typeof a[b]?+a[b].replace(",","."):null;return{date:m(a.datum),value:c}}).filter(function(a){return!isNaN(a.value)});return{name:c.key,values:d}});return{name:e[b],subgroups:c}}).filter(function(a){return"undefined"!=typeof a.name}),h.category=d(h.category),h.industry=d(h.industry),c("industry",h.industry),c("category",h.category)}var f,g="1JGCoMlEqUaspT-S_7UK-lVK8JfzHItdHyUQO_LYdFus",h={};Handlebars.registerHelper("dictionary",function(a,b,c){return a=f.get(a)[b],c&&(a=a.toLowerCase()),a});var i=[{v0:7.5,v1:12.5,label:"Väldigt optimistisk",labelDetermined:"Väldigt optimistiskt",className:"p3"},{v0:2.5,v1:7.5,label:"Optimistisk",labelDetermined:"Optimistiskt",className:"p2"},{v0:0,v1:2.5,label:"Försiktigt optimistisk",labelDetermined:"Försiktigt optimistiskt",className:"p1"},{v0:-2.5,v1:0,label:"Försiktigt pessimistisk",labelDetermined:"Försiktigt pessimistiskt",className:"n1"},{v0:-7.5,v1:-2.5,label:"Pessimistisk",labelDetermined:"Pessimistiskt",className:"n2"},{v0:-12.5,v1:-7.5,label:"Väldigt pessimistisk",labelDetermined:"Väldigt pessimistiskt",className:"n3"}].map(function(b){return b.color=a("color","."+b.className),b});Array.prototype.first||(Array.prototype.first=function(a){if(null==this)throw new TypeError;if("function"!=typeof a)throw new TypeError;for(var b=0;b<this.length;b++)if(a(this[b]))return this[b];return null});var j=function(){for(var a={},b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if("undefined"==typeof a[e[0]])a[e[0]]=e[1];else if("string"==typeof a[e[0]]){var f=[a[e[0]],e[1]];a[e[0]]=f}else a[e[0]].push(e[1])}return a}(),k=d3.locale({decimal:",",thousands:" ",grouping:[3],currency:[""," kr"],dateTime:"%A %e %B %Y kl. %X",date:"%d.%m.%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["måndag","tisdag","onsdag","torsdag","fredag","lördag","söndag"],shortDays:["må","ti","ons","to","fre","lö","sö"],months:["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"],shortMonths:["jan","feb","mars","apr","maj","jun","jul","aug","sept","okt","nov","dec"]}),l=k.timeFormat("%B %Y"),m=k.timeFormat("%Y-%m-%d").parse,n=function(){this.cached={}},o=new n,p=function(a){var b=i.first(function(b){return b.v0<a&&a<=b.v1});return b},q=function(){function a(a,b,c,d,e){var g,h,j,k,m=this;m.container=a,m.el=a.select(".chart"),m.summary=a.select(".summary");var n=.9*d3.select("#accordion")[0][0].offsetWidth;m.margin={top:10,bottom:30,right:20,left:10};var o=m.margin;m.width=g=n-o.left-o.right,m.height=h=.35*g,a.select(".chart-intro .group-name").text(f.get(d).determined.toLowerCase()),m.date1=k=b[0].date,m.date0=j=b[b.length-1].date,m.min=-9,m.max=9,m.x=d3.time.scale().range([0,g]).domain([j,k]),m.y=d3.scale.linear().range([h,0]).domain([m.min,m.max]),m.svg=m.el.append("svg").attr("width",g+o.left+o.right).attr("height",h+o.top+o.bottom),m.chart=m.svg.append("g").attr("transform","translate("+o.left+","+o.top+")").on("mouseout",function(){m.tooltip.style("visibility","hidden")});var q=d3.geom.voronoi().clipExtent([[0,0],[g,h]]),r=b.map(function(a){var b=[m.x(a.date),m.y(a.value)],c=p(a.value);return[b[0],b[1],{date:a.date,value:a.value,outlook:c}]}),s=q(r);m.tooltip=d3.select("body").append("div").attr("class","d3-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").on("mouseover",function(){return m.tooltip.style("visibility","hidden")}),m.bgAreas=m.chart.selectAll("g.bg-area").data(i).enter().append("g").attr("class","bg-area").attr("transform",function(a){return"translate(0,"+m.y(a.v1)+")"}),m.bgAreas.append("rect").attr("x",-m.margin.left).attr("width",m.margin.left).attr("height",function(a){return Math.abs(m.y(a.v1)-m.y(a.v0))}).attr("fill",function(a){return a.color}),m.bgAreas.append("line").attr("x1",0).attr("x2",g).attr("y1",function(a){return a.v1>0?0:m.y(a.v0)-m.y(a.v1)}).attr("y2",function(a){return a.v1>0?0:m.y(a.v0)-m.y(a.v1)}).attr("stroke",function(a){return a.color}).attr("class","guideline"),m.chart.append("line").attr("x1",0).attr("x2",g).attr("y1",m.y(0)).attr("y2",m.y(0)).attr("class","guideline zero").attr("transform","translate(1,0)"),m.xAxis=d3.svg.axis().scale(m.x).orient("bottom").ticks(3),m.chart.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(m.xAxis),m.line=d3.svg.line().x(function(a){return m.x(a.point[2].date)}).y(function(a){return m.y(a.point[2].value)}),m.chart.append("path").datum(s).attr("class","line").attr("d",m.line),m.dots=m.chart.selectAll("g.poll").data(s).enter().append("g").attr("class","poll"),m.dotSize=4,m.dots.append("circle").attr("r",m.dotSize).attr("cx",m.dotSize/2).attr("class","dot").attr("transform",function(a){return"translate("+[a.point[0],a.point[1]]+")"}),m.dots.append("path").attr("class","voronoi").attr("opacity",1e-6).attr("d",function(a){return"M"+a.join("L")+"Z"}).on("mouseover",function(){var a=this.parentNode.childNodes[0],b=document.body.getBoundingClientRect(),c=a.getBoundingClientRect(),d={top:c.top-b.top,left:c.left-b.left},e=d3.select(a),f=e[0][0].__data__,g=f.point[2].outlook;return e.transition().duration(200).attr("r",2*m.dotSize),m.tooltip.html('<table><tr><td><span class="icon-arrow outlook '+g.className+'"></span></td><td><date>'+l(f.point[2].date)+"</date> "+g.label+"</td></tr></table>").style("visibility","visible").style("top",d.top-65+"px").style("left",function(){var a=this.getBoundingClientRect().width;return d.left-a/2+"px"})}).on("mouseout",function(){var a=d3.select(this.parentNode.childNodes[0]);a.transition().duration(200).attr("r",m.dotSize)}),m.getSentences=function(a,b,c,d){function e(a){return"<strong>"+a.label.toLowerCase()+"</strong>"}var g,h=a[0].value,i=a[1].value,j=p(h),k=j.labelDetermined.toLowerCase(),l=h>i?"postiv":"negativ",m=h>i&&h>0||i>h&&0>h?"även":"dock",n=Math.abs(h-i);1>n?g="något":2>n?g="":3>n&&(g="betydligt");var o={};if(d){if("industry"==b)var q=f.get(c).determined.toLowerCase(),r=f.get(d).determined.toLowerCase();else if("category"==b)var q=f.get(d).determined.toLowerCase(),r=f.get(c).determined.toLowerCase();o.long="Inom "+q+" ser man <strong>"+k+"</strong> på utvecklingen för "+r+" det kommande halvåret."}else{var s=f.get(c).determined.toLowerCase();"industry"==b?o.long="Inom "+s+" ser man just nu "+e(j)+"  på framtiden. ":"category"==b&&(o.long="Unionens medlemmar ser just nu "+e(j)+" på framtiden för "+s+". ")}return o.long+="Man är "+m+" <strong>"+g+" mer "+l+"</strong> än för sex månader sedan.",o.title="Trenden: "+g+" mer "+l+" än senast",o};var t=m.getSentences(b,c,d,e);m.summary.select(".sentence").html(t.long),m.container.select(".history h5").html(t.title)}return a}();$(document).ready(function(){$.extend(n.prototype,{render:function(a,b){o.isCached(a)?b(o.cached[a]):$.get(o.urlFor(a),function(c){o.store(a,c),o.render(a,b)})},renderSync:function(a,b){o.isCached(a)||o.fetch(a),o.render(a,b)},prefetch:function(a){$.get(o.urlFor(a),function(b){o.store(a,b)})},fetch:function(a){if(!o.isCached(a)){var b=$.ajax({url:o.urlFor(a),async:!1}).responseText;o.store(a,b)}},isCached:function(a){return!!o.cached[a]},store:function(a,b){o.cached[a]=Handlebars.compile(b)},urlFor:function(a){return"templates/"+a+".hbs"}}),o.render("main",function(a){$("#konjunkturbarometern").html(a()),Tabletop.init({key:g,callback:e,proxy:"https://s3-eu-west-1.amazonaws.com/tabletop-proxy/unionen-konjunkturbarometern-stage/",debug:!0})})})}();